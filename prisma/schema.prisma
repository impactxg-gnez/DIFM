generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Valid Roles: CUSTOMER, PROVIDER, ADMIN
// Valid Categories: HANDYMAN, CLEANING, PEST_CONTROL, ELECTRICIAN, PLUMBER, CARPENTER, PAINTER, PC_REPAIR
// Valid JobStatuses: CREATED, DISPATCHED, ACCEPTED, IN_PROGRESS, COMPLETED, CLOSED, PAID, CANCELLED_FREE, CANCELLED_CHARGED, DISPUTED

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  name            String
  passwordHash    String
  role            String   @default("CUSTOMER")
  
  // Provider specific (Milestone 2)
  isOnline        Boolean  @default(false)
  providerType    String?  // "HANDYMAN" or "SPECIALIST"
  providerStatus  String?  // "PENDING", "ACTIVE", "PAUSED", "BANNED" - only ACTIVE can receive jobs
  categories      String?  // Comma-separated list of categories (SQLite workaround for String[])
  capabilities    String?  // Comma-separated list of capabilities (e.g., "HANDYMAN_PLUMBING,HANDYMAN_ELECTRICAL")
  serviceArea     String?  // Basic location coverage description
  complianceConfirmed Boolean @default(false) // Compliance confirmation checkbox
  latitude        Float?
  longitude       Float?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Provider documents
  documents       ProviderDocument[]

  // Relations
  jobsCreated     Job[]    @relation("CustomerJobs")
  jobsAssigned    Job[]    @relation("ProviderJobs")
  
  // Financials
  transactions    Transaction[]
  
  // Reviews
  customerReviews CustomerReview[] @relation("CustomerReviews")
  providerReviews CustomerReview[] @relation("ProviderReviews")
  adminReviews    AdminReview[]
}

model Job {
  id          String    @id @default(uuid())
  description String
  location    String    // Human readable address
  latitude    Float?
  longitude   Float?
  
  // Job Specifics
  category    String    // One of the valid categories
  fixedPrice  Float
  priceLockedAt DateTime?
  isASAP      Boolean   @default(true)
  scheduledAt DateTime? // If not ASAP
  
  status      String    @default("CREATED")
  statusUpdatedAt DateTime @default(now())
  dispatchRadius Int    @default(5) // In km, expands over time
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  acceptedAt  DateTime?
  
  // Cancellation
  cancellationReason String?
  
  // Pricing flags for intelligent pricing
  isParsed    Boolean  @default(false)  // Whether AI parsed the description
  needsReview Boolean  @default(false)  // Admin review required
  priceOverride Float? // Manual admin override
  platformFeeOverride Float? // Manual admin override for platform fee
  isRefunded Boolean @default(false)
  requiredCapability String? // "HANDYMAN_PLUMBING", "HANDYMAN_ELECTRICAL" - for dispatch logic
  
  // Parts & Materials (Phase 2: non-financial tracking)
  partsExpectedAtBooking String? // "YES", "NO", "NOT_SURE" - customer indication at booking
  partsRequiredAtCompletion String? // "YES", "NO", "N/A" - provider confirmation at completion
  partsCost Float? // Financial tracking of parts cost
  partsNotes String? // Provider notes about parts used
  partsPhotos String? // Comma-separated URLs or paths to photos
  
  // Completion evidence
  completionNotes String? // Required notes from provider before COMPLETED status
  completionPhotos String? // Comma-separated URLs or paths to completion photos/videos
  completionLat Float?
  completionLng Float?
  completionLocationVerified Boolean @default(false)
  
  // Dispute tracking (Milestone 4)
  disputeReason String? // Customer's reason for dispute
  disputeNotes String? // Additional customer notes
  disputePhotos String? // Comma-separated photo URLs
  disputedAt DateTime? // When dispute was raised
  disputeResolvedAt DateTime? // When admin resolved dispute
  disputeResolution String? // Admin resolution notes
  
  // Payment tracking (Milestone 4)
  customerPaidAt DateTime? // When customer payment was captured
  paymentMethod String? // "MANUAL", "SIMULATED", "GATEWAY"
  paymentReference String? // External payment reference/transaction ID
  
  // Sequential Assignment (Step 5)
  offeredToId String?
  offeredAt   DateTime?
  triedProviderIds String? // Comma-separated list of provider IDs who have been offered the job
  
  // Arrival & Timer (Step 5)
  arrivalWindowStart DateTime?
  arrivalWindowEnd   DateTime?
  timerStartedAt     DateTime?
  timerPausedAt      DateTime?
  isAccessAvailable  Boolean   @default(false)
  
  // Relations
  customerId  String
  customer    User      @relation("CustomerJobs", fields: [customerId], references: [id])
  
  providerId  String?
  provider    User?     @relation("ProviderJobs", fields: [providerId], references: [id])

  isSimulation Boolean   @default(false)

  transactions Transaction[]
  customerReview CustomerReview?
  adminReview    AdminReview?
  items       JobItem[]
  visits      Visit[]
  stateChanges JobStateChange[]
  priceOverrides PriceOverride[]
}

model Transaction {
  id        String   @id @default(uuid())
  amount    Float
  type      String   // PAYOUT, CHARGE, FEE
  status    String   // PENDING, COMPLETED, FAILED
  
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id])
  
  userId    String?  // Who is this transaction for (e.g. Provider for Payout, Customer for Charge)
  user      User?    @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
}

model CustomerReview {
  id          String   @id @default(uuid())
  rating      Int
  comment     String?
  createdAt   DateTime @default(now())

  jobId       String   @unique
  job         Job      @relation(fields: [jobId], references: [id])
  
  customerId  String
  customer    User     @relation(name: "CustomerReviews", fields: [customerId], references: [id])
  
  providerId  String
  provider    User     @relation(name: "ProviderReviews", fields: [providerId], references: [id])
}

model AdminReview {
  id          String   @id @default(uuid())
  rating      Int?
  notes       String?
  decision    String?  // e.g. "APPROVED", "REJECTED"
  createdAt   DateTime @default(now())

  jobId       String   @unique
  job         Job      @relation(fields: [jobId], references: [id])

  reviewerId  String
  reviewer    User     @relation(fields: [reviewerId], references: [id])
}

model PricingRule {
  id          String   @id @default(uuid())
  category    String   // e.g., "HANDYMAN"
  itemType    String   // e.g., "MOUNT_TV", "SHELF", "GENERAL_HOUR"
  basePrice   Float    // Base price for this item
  unit        String   // "ITEM", "HOUR", "SQ_FT"
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model JobItem {
  id          String   @id @default(uuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id])
  
  itemType    String   // References PricingRule.itemType
  quantity    Int      @default(1)
  unitPrice   Float
  totalPrice  Float
  
  description String?  // Parsed from customer input
  
  createdAt   DateTime @default(now())
}

model JobStateChange {
  id          String   @id @default(uuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id])
  fromStatus  String
  toStatus    String
  reason      String?
  changedById String?
  changedByRole String?
  createdAt   DateTime @default(now())
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String   // "OVERRIDE_FEE", "PROVIDER_STATUS", "JOB_CANCEL", etc.
  entityId    String   // ID of the job, provider, etc.
  entityType  String   // "JOB", "PROVIDER", "PRICING_RULE"
  details     String?  // JSON string or text description
  actorId     String
  createdAt   DateTime @default(now())
}

model PriceOverride {
  id          String   @id @default(uuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id])
  oldPrice    Float
  newPrice    Float
  reason      String
  changedById String?
  changedByRole String?
  createdAt   DateTime @default(now())
}

model ProviderDocument {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentType String   // "ID_PROOF", "LIABILITY_INSURANCE"
  fileUrl     String   // URL or path to uploaded document
  uploadedAt  DateTime @default(now())
  verifiedAt  DateTime? // When admin verified (optional for now)
}

// --- V1 Pricing Matrix Models ---

model CatalogueItem {
  id                      String   @id @default(uuid())
  job_item_id             String   @unique // Human readable unique ID e.g. "tv_mount_standard"
  display_name            String
  item_class              String   // "STANDARD", "CLEANING", "SPECIALIST"
  
  required_capability_tags String[] // Postgres array
  time_weight_minutes     Int
  
  allowed_addon           Boolean
  uncertainty_prone       Boolean
  uncertainty_handling    String   // "IGNORE", "BUFFER", "FORCE_H3"
  risk_buffer_minutes     Int?
  
  notes                   String?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

model Visit {
  id              String   @id @default(uuid())
  
  jobId           String
  job             Job      @relation(fields: [jobId], references: [id])
  
  // Visit Details
  item_class      String   // "STANDARD", "CLEANING", "SPECIALIST"
  primary_job_item_id String
  addon_job_item_ids  String[]
  
  required_capability_tags_union String[]
  
  base_minutes    Int
  effective_minutes Int
  tier            String   // "H1", "H2", "H3"
  price           Float
  
  status          String   @default("DRAFT") // "DRAFT", "SCHEDULED", "COMPLETED", etc.
  
  scopeSummary    ScopeSummary?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ScopeSummary {
  id                    String   @id @default(uuid())
  
  visitId               String   @unique
  visit                 Visit    @relation(fields: [visitId], references: [id])
  
  primary_job_item_id   String
  addon_job_item_ids    String[]
  visit_tier            String
  effective_minutes     Int
  includes_text         String
  excludes_text         String
  parts_rule_text       String
  mismatch_rule_text     String
  scope_lock_answers    Json     // Key/Value
  
  createdAt             DateTime @default(now())
}

model JobPattern {
  id              String   @id @default(uuid())
  category        String   // PLUMBING, ELECTRICAL, HANDYMAN, etc.
  keywords        String   // JSON array: ["pipe", "leak"]
  catalogueItemId String   // e.g., "tap_leak_fix"
  description     String   // Human-readable description
  examplePhrases  String?  // Optional: example user inputs
  isActive        Boolean  @default(true)
  priority        Int      @default(0) // Higher priority = checked first
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([category])
  @@index([catalogueItemId])
}
